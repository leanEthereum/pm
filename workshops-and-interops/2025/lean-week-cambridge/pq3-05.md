# pq3-05: Lean p2p

## Categories
- PQ-devnet

## Related Talks
- [pq1-10](pq1-10.md): PQ P2P Aggregation
- [pq1-15](pq1-15.md): P2P Performance
- [pq3-01](pq3-01.md): PQ Ethereum Workshop - Day 3 Kickoff
- [pq3-08](pq3-08.md): PQ Ethereum Workshop - Day 3 Recap

## Summary
Thomas Thiery from the Ethereum Foundation's Robust Incentives Group presented on optimizing peer-to-peer (p2p) message propagation for a lean Ethereum future, emphasizing efficiency under real-world constraints. Starting from first principles—how to propagate messages efficiently across nodes—he introduced constraints like partial/local views, bandwidth/time limits, robustness against attacks, dynamic conditions, privacy, message heterogeneity, and overlapping duties. He proposed a "p2p trilemma" balancing resilience, efficiency, and leanness, noting current systems excel in resilience but lag in the others.

Thiery critiqued Gossipsub's current setup: a mesh of ~50 scored peers, eager push to 8 random peers, and lazy gossip fallback via IWANT/IDONTWANT. While robust with good coverage and decent latency, it's bandwidth-inefficient and not lean. He focused on improving eager push, questioning if a single tunable rule could optimize across message types (e.g., attestations vs. blobs).

Theoretical foundations model the network as a weighted graph with round-trip times (RTTs) on edges, assuming a fixed random d-regular topology (mirroring peer scoring meshes) and local decisions only. Optimization targets include coverage (≥90% nodes informed), bandwidth (average duplicates), and latency (t₉₀).

Simulations used an Erdős–Rényi graph (N=1500, mean degree=50, per-topic mesh=8) with lognormal RTTs (median 100ms, σ=1). RTT-unaware rules (random, coin-toss) were compared to aware ones (Δ-fastest: forward to fastest Δ peers; downhill: forward if RTT_out < RTT_in). RTT-aware rules improved latency and reduced duplicates, with downhill inspired by optimal transport/physical distribution problems.

To ensure coverage, a random backbone hits percolation threshold (2-3 peers). Hybrid rules add: absolute threshold T (forward if RTT_out < T) or SOON (RTT_out < RTT_in * (1+S), where S is slack). In lognormal distributions, both perform similarly, but in bimodal (heterogeneous) distributions, SOON excels due to local adaptability, dominating in clustered networks (e.g., geographic/ASNs).

The session concluded with takeaways on network heterogeneity dictating strategies, SOON's suitability for heterogeneous setups, and tuning S for latency-bandwidth trade-offs. Next steps include empirical data collection (RTT distributions, topology), realistic simulations (libp2p in Shadow emulator), devnets, and ACD presentation. Additional thoughts covered interactions with peer scoring/lazy gossip and formal proofs of near-optimality.

Q&A explored current scoring's latency components, graph topology/churn, bucketing by distance (with gaming/privacy concerns), erasure coding for large messages, proof-of-location, message-specific tailoring (without overfitting), larger-scale simulations (up to 50k nodes showing amplified RTT-aware gains), and applications to signature aggregation (potential 40% bandwidth efficiency, 10-20% latency improvements).

## Key Takeaways
- Network heterogeneity and topology (e.g., geographic clustering) determine optimal propagation strategies; SOON performs best in heterogeneous setups by adapting locally.
- Tune SOON's slack parameter S to trade off latency and bandwidth: low S for fast propagation (e.g., attestations), high S for efficiency (e.g., blobs).
- RTT-aware rules like SOON/Δ-fastest reduce duplicates by ~40% for similar latency compared to random, with near-optimal latency at higher duplicates.
- Random backbones ensure percolation/coverage; hybrid rules combine robustness with efficiency.
- Empirical data on real Ethereum RTT distributions and topology is crucial; interactions with peer scoring and lazy gossip need exploration.
- Potential for formal proofs of near-optimality; ship SOON before full Lean Ethereum for quick wins.

## Speakers
- [Thomas Thiery](https://x.com/soispoke) (EF - RIG)

## Resources
- [Slides](https://drive.google.com/file/d/1X7_uQpidLJVcIxIfpPb0WEgj-R627r7L/view?usp=drive_link)
- [Video](https://youtu.be/zqJrSZTsHGU)

> back to: [Index Page](index.md)

*Note: Summaries were generated in part with the help of AI, so names and terms may not be 100% accurate.*