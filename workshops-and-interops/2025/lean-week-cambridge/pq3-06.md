# pq3-06: New ZK-Friendly Encoding for Aggregatable XMSS Signatures

## Categories
- PQ-implementation

## Related Talks
- [pq1-04](pq1-04.md): Introduction to LeanSig
- [pq1-06](pq1-06.md): XMSS Signature Aggregation
- [pq3-02](pq3-02.md): LeanSig KeyGen & API
- [pq3-08](pq3-08.md): PQ Ethereum Workshop - Day 3 Recap

## Summary
Dmitry Khovratovich from the Ethereum Foundation presented a technical deep dive into a new zero-knowledge (ZK)-friendly encoding for aggregatable XMSS signatures, aimed at making them efficient for Ethereum's post-quantum (PQ) consensus. The talk focused on the encoding as a mapping from message and randomness to positions on hash chains, conceptualized as layers in a hypercube where coordinates sum to a fixed D. The signature includes randomness and a Merkle path from the node set to the public key root.

Khovratovich explained the need for uniform sampling from hypercube layer D with v coordinates (around 60-70) each from 0 to w-1 (w=8), inspired by simplex sampling in continuous space using sorted exponential variables, adapted to integers to avoid biases from collisions. The new encoding uses Poseidon hash in sponge mode to generate field elements, rejection sampling to filter values below a threshold (4Q^4, where Q = D + v -1), trimming/splitting into base-Q digits, collecting distinct entries by ignoring duplicates, and computing differences for positions, aborting if any exceed w-1.

The circuit implementation involves flags for skipping invalid elements, efficient range checks using memory read failures, a boolean array for distinct values, and collecting differences. Security analysis requires large t for overwhelming probability of sufficient distinct entries in proofs, but practical implementations can use smaller t with hints or early stopping. Q&A discussed circuit control flow for rejections, alternative sampling like Fisher-Yates, quantum security proofs in random oracle model, non-uniformity issues, and practical vs. theoretical parameters, with suggestions for optimizations to reduce rejections and ensure uniformity.

## Key Takeaways
- The encoding maps to hypercube layers for uniform positions on hash chains, enabling efficient ZK aggregation of XMSS signatures.
- Uniform sampling adapts simplex method to integers via rejection sampling and collision handling to avoid biases.
- Circuit uses Poseidon sponge (2 calls for ~25 elements), flags, range checks via memory fails, and boolean array for distinctness, with aborts for out-of-bound positions.
- Security requires large t (~75) for negligible failure probability (2^{-128}), but practical t'~55, with hints for verifier efficiency.
- Probability of valid output without rejection is ~97.5%, low overhead; non-uniformity complicates proofs and opens attack vectors.
- Future work: formal security with rejection handling, circuit optimizations for control flow, implementation benchmarks.

## Speakers
- Dmitry Khovratovich (EF - cryptography)

## Resources
- [Slides](https://drive.google.com/file/d/15LeFvY8hzrHD2wBAwCFJOKbM4oPmcxi4/view?usp=drive_link)
- [Video](https://youtu.be/I8-GYvVOxLA)

> back to: [Index Page](/workshops-and-interops/2025/lean-week-cambridge/index.md)

*Note: Summaries were generated in part with the help of AI, so names and terms may not be 100% accurate.*